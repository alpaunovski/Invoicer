<Window x:Class="InvoiceDesk.MainWindow"
    x:Name="RootWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:InvoiceDesk"
        xmlns:helpers="clr-namespace:InvoiceDesk.Helpers"
        xmlns:models="clr-namespace:InvoiceDesk.Models"
        mc:Ignorable="d"
        MinHeight="700" MinWidth="1100"
        Title="{Binding Source={StaticResource Loc}, Path=[AppTitle]}">
    <Window.Resources>
        <helpers:StatusToLocalizedConverter x:Key="StatusConverter" />
    </Window.Resources>
    <DockPanel>
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="12" VerticalAlignment="Center">
            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[CompanyLabel]}" VerticalAlignment="Center" />
            <ComboBox Width="200" Margin="6 0 0 0" ItemsSource="{Binding Companies}" SelectedItem="{Binding SelectedCompany}" DisplayMemberPath="Name" />

            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[LanguageLabel]}" VerticalAlignment="Center" Margin="12 0 0 0" />
            <ComboBox Width="150" Margin="6 0 0 0" ItemsSource="{Binding Cultures}" SelectedValuePath="Code" DisplayMemberPath="Label" SelectedValue="{Binding SelectedCulture}" />

            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[Customer]}" VerticalAlignment="Center" Margin="12 0 0 0" />
            <ComboBox Width="180" Margin="6 0 0 0" ItemsSource="{Binding Customers}" SelectedItem="{Binding SelectedCustomerForDraft}" DisplayMemberPath="Name" />

            <Button Content="{Binding Source={StaticResource Loc}, Path=[NewDraft]}" Command="{Binding NewDraftCommand}" Margin="12 0 0 0" />
            <Button Content="{Binding Source={StaticResource Loc}, Path=[Save]}" Command="{Binding SaveCommand}" Margin="6 0 0 0" />
            <Button Content="{Binding Source={StaticResource Loc}, Path=[Issue]}" Command="{Binding IssueCommand}" Margin="6 0 0 0" />
            <Button Content="{Binding Source={StaticResource Loc}, Path=[ExportPdf]}" Command="{Binding ExportPdfCommand}" Margin="6 0 0 0" />
            <Button Content="{Binding Source={StaticResource Loc}, Path=[ManageCompanies]}" Click="OpenCompanies" Margin="12 0 0 0" />
            <Button Content="{Binding Source={StaticResource Loc}, Path=[ManageCustomers]}" Click="OpenCustomers" Margin="6 0 0 0" />
        </StackPanel>

        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem Content="{Binding StatusMessage}" />
        </StatusBar>

        <Grid Margin="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="3*" />
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" BorderBrush="#DDD" BorderThickness="1" Padding="10" CornerRadius="6">
                <StackPanel>
                    <TextBlock FontWeight="SemiBold" Text="{Binding Source={StaticResource Loc}, Path=[InvoiceList]}" />
                    <StackPanel Orientation="Horizontal" Margin="0 8 0 8">
                        <TextBox Width="160" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Margin="0 0 6 0" />
                        <DatePicker SelectedDate="{Binding FromDate}" Margin="0 0 6 0" />
                        <DatePicker SelectedDate="{Binding ToDate}" Margin="0 0 6 0" />
                        <Button Content="{Binding Source={StaticResource Loc}, Path=[Search]}" Command="{Binding RefreshCommand}" />
                    </StackPanel>
                    <ListBox ItemsSource="{Binding Invoices}" SelectedItem="{Binding SelectedInvoiceSummary, Mode=TwoWay}" Height="700">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="4">
                                    <TextBlock Text="{Binding InvoiceNumber}" FontWeight="SemiBold" />
                                    <TextBlock Text="{Binding CustomerNameSnapshot}" FontSize="12" />
                                    <TextBlock Text="{Binding Status, Converter={StaticResource StatusConverter}}" FontSize="12" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </Border>

            <Border Grid.Column="1" BorderBrush="#DDD" BorderThickness="1" Padding="10" CornerRadius="6" Margin="8 0 0 0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Margin="0 0 0 12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0 0 8 0">
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[InvoiceNumber]}" />
                            <TextBox Text="{Binding SelectedInvoice.InvoiceNumber, Mode=TwoWay}" IsReadOnly="True" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[Customer]}" />
                            <ComboBox ItemsSource="{Binding Customers}" SelectedValuePath="Id" DisplayMemberPath="Name" SelectedValue="{Binding SelectedInvoice.CustomerId, Mode=TwoWay}" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[Notes]}" />
                            <TextBox Text="{Binding SelectedInvoice.Notes, Mode=TwoWay}" AcceptsReturn="True" Height="60" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="8 0 0 0">
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[IssueDate]}" />
                            <DatePicker SelectedDate="{Binding SelectedInvoice.IssueDate, Mode=TwoWay}" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[StatusLabel]}" />
                            <TextBox Text="{Binding SelectedInvoice.Status, Converter={StaticResource StatusConverter}}" IsReadOnly="True" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[InvoiceLanguageLabel]}" />
                            <ComboBox ItemsSource="{Binding Cultures}" SelectedValuePath="Code" DisplayMemberPath="Label" SelectedValue="{Binding SelectedInvoice.InvoiceLanguage, Mode=TwoWay}" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[Currency]}" />
                            <TextBox Text="{Binding SelectedInvoice.Currency, Mode=TwoWay}" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[VatLabel]}" />
                            <TextBox Text="{Binding SelectedCompany.VatNumber}" IsReadOnly="True" />
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[EikLabel]}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedCompany.CountryCode}" Value="BG">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <TextBox Text="{Binding SelectedCompany.Eik}" IsReadOnly="True">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedCompany.CountryCode}" Value="BG">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>
                        </StackPanel>
                    </Grid>

                    <Grid Grid.Row="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0">
                            <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[Lines]}" FontWeight="SemiBold" />
                            <DataGrid x:Name="LinesGrid" ItemsSource="{Binding SelectedInvoice.Lines}" AutoGenerateColumns="False" CanUserAddRows="True" CanUserDeleteRows="True" IsReadOnly="False"
                                      Language="{Binding UiLanguage}"
                                      IsEnabled="{Binding SelectedInvoice.IsDraft}" Margin="0 6 0 6">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="{Binding Source={StaticResource Loc}, Path=[DescriptionLabel]}" Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Width="*" />
                                    <DataGridTextColumn Header="{Binding Source={StaticResource Loc}, Path=[QuantityLabel]}" Binding="{Binding Qty, UpdateSourceTrigger=PropertyChanged, StringFormat=F3}" Width="80" />
                                    <DataGridTextColumn Header="{Binding Source={StaticResource Loc}, Path=[UnitPriceLabel]}" Binding="{Binding UnitPrice, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}" Width="100" />
                                    <DataGridTextColumn Header="{Binding Source={StaticResource Loc}, Path=[TaxRateLabel]}" Binding="{Binding TaxRate, UpdateSourceTrigger=PropertyChanged, StringFormat=F4}" Width="80" />
                                    <DataGridComboBoxColumn Header="{Binding Source={StaticResource Loc}, Path=[VatTypeLabel]}"
                                                            SelectedValueBinding="{Binding VatType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, TargetNullValue={x:Static models:VatType.Domestic}, FallbackValue={x:Static models:VatType.Domestic}}"
                                                            SelectedValuePath="Value"
                                                            DisplayMemberPath="Label"
                                                            Width="180">
                                        <DataGridComboBoxColumn.ElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.VatTypes, RelativeSource={RelativeSource AncestorType=Window}, PresentationTraceSources.TraceLevel=High}" />
                                                <Setter Property="IsReadOnly" Value="True" />
                                            </Style>
                                        </DataGridComboBoxColumn.ElementStyle>
                                        <DataGridComboBoxColumn.EditingElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.VatTypes, RelativeSource={RelativeSource AncestorType=Window}, PresentationTraceSources.TraceLevel=High}" />
                                            </Style>
                                        </DataGridComboBoxColumn.EditingElementStyle>
                                    </DataGridComboBoxColumn>
                                    <DataGridTextColumn Header="{Binding Source={StaticResource Loc}, Path=[Total]}" Binding="{Binding LineTotal, Mode=TwoWay, StringFormat=F2}" Width="100" IsReadOnly="True" />
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="{Binding Source={StaticResource Loc}, Path=[AddLine]}" Command="{Binding AddLineCommand}" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                                <Button Content="{Binding Source={StaticResource Loc}, Path=[RemoveLine]}" Command="{Binding RemoveLineCommand}" CommandParameter="{Binding SelectedItem, ElementName=LinesGrid}" IsEnabled="{Binding SelectedInvoice.IsDraft}" />
                            </StackPanel>
                        </StackPanel>

                        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <StackPanel>
                                <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[SubTotal]}" />
                                <TextBlock Text="{Binding Source={StaticResource Loc}, Path=[TaxTotal]}" />
                                <TextBlock FontWeight="Bold" Text="{Binding Source={StaticResource Loc}, Path=[Total]}" />
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="{Binding SelectedInvoice.SubTotal, StringFormat=F2}" />
                                <TextBlock Text="{Binding SelectedInvoice.TaxTotal, StringFormat=F2}" />
                                <TextBlock FontWeight="Bold" Text="{Binding SelectedInvoice.Total, StringFormat=F2}" />
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </DockPanel>
</Window>
